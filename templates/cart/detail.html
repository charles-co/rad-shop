{% extends 'base.html' %}
{% load thumbnail %}
{% load static %}
{% load extras %}
{% block style %}
<style>
    .list-move{
        transition: transform 1s;
    }
    .list-leave-active{
        transition: all 1s;
        opacity: 0;
        color: white;
        animation: slide-out 1s ease-out forwards;
    }

    @keyframes slide-out {
        from {
            transform: translateY(0);
            height: 201px;
        }
        to {
            transform: translateX(-100px);
            height: 0;
        }
    }
</style>
{% endblock style%}
{% block content %}
<div class="container" id="cart-app">
    <p class="display-4">Cart <i class="fas fa-shopping-bag text-success"></i></p>
        <transition
            enter-active-class="animate__animated animate__slideInLeft"
            leave-active-class="animate__animated animate__hinge"
        >
            <div class="toast position-absolute" v-if="toast" role="alert" :style="{top: topT + 'px'}" style="min-width:262px;left:0;opacity:1;z-index:1000;" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <img src="{% static 'image/favicon.ico' %}" class="rounded mr-2" alt="Rad">
                    <strong class="mr-auto">Rad</strong>
                    <small>0 mins ago</small>
                </div>
                <div class="toast-body">
                    <span class="text-muted">Maximum stock reached <i class="fas fa-running"></i></span>
                </div>
            </div>
        </transition>
    <div class="row justify-content-center">
        <div class="col-12 col-md-12" ref="bustop" v-if="trousers.length > 0">
            <transition-group tag="ul" name="list" class="list-group d-flex flex-row flex-wrap list-group-flush">
                <li v-for="(trouser, index) in trousers" :key="trouser.key" class="list-group-item shadow px-0 col-md-6 col-lg-4 list-group-item-darbk">
                    <div class="d-flex justify-content-between">
                        <div class="p-2">                 
                            <a :href="trouser.url">
                                <img :src="[[ trouser.image_url ]]" class="">
                            </a>
                        </div>
                        <div class="py-2 px-0">
                            <p>[[ trouser.name ]]</p>
                            <p class="">[[ trouser.total_price|currency ]]</p>
                            <button class="btn btn-sm btn-outline-dark" @click="decrementQuantity(trouser.id, trouser.size, trouser.quantity, trouser.price)">-</button><span class="mx-1">[[ trouser.quantity ]]</span><button class="btn btn-sm btn-outline-dark" @click="incrementQuantity(trouser.id, trouser.size, trouser.quantity, trouser.price)">+</button>
                            <button @click="removeFromCart(trouser.id, trouser.size, trouser.quantity, trouser.total_price)" class="btn btn-transparent p-0 ml-4 my-2 add-to-cart btn-outline-transparent d-block"><i class="fas fa-trash-alt text-danger"></i></button>
                        </div>
                        <div class="p-2">
                            <p class="text-muted mb-1 font-smaller font-italic" style="font-size:11px;">([[ trouser.price|currency ]])</p>
                            <small class="text-muted font-smaller font-italic" style="font-size:10px">[[ trouser.size ]]</small>

                        </div>
                    </div>
                </li>
            </transition-group>
            <p class="h3">Total <i class="fas fa-shopping-b"></i>[[get_total_price|currency]]</p>
            <div class="col-12 col-md-6 px-0 my-5">
                <a href="{% url 'cart:checkout' %}" class="btn btn-block btn-lg btn-success rounded-0">Checkout</a>
            </div>
        </div>
        <div v-if="trousers.length === 0" class="col-md-3 col-6 my-5 animate__animated animate__tada">
            <div class="d-flex flex-column justify-content-center">
                <p class="h3 text-center my-4">Oops, no item in cart <i class="fas fa-grin-beam-sweat"></i></p>
                <a class="btn btn-link btn-md text-decoration-none btn-primary text-white rounded-0" href="{% url 'menu:trouser_by_category' 'collections' %}">Go To Collections</a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block javascript %}
<script src="{% static 'js/lodash.min.js' %}"></script>
<script>
const formatter = new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'NGN', 
                                        minimumFractionDigits: 2
                                    })
const cartapp = new Vue({
        delimiters: ['[[', ']]'],
        el: '#cart-app',
        store: store,
        data (){
            return {
                trousers: [{{ trousersString|safe }}],
                toast: false,
                topT:0,
            }
        },
        mounted(){
            console.log("mounted")
            console.log(this.trousers)

        },
        computed: {
            numItems: function(){
                return store.state.numItems;
            },
            get_total_price: function(){
                return store.state.get_total_price;
            }
        },
        filters: {
            currency: function(value){
                if (!value) return ''
                value = formatter.format(value)
                return value
            },
        },
        methods: {
            removeFromCart(trouser_id, size, quantity, price){
                let data = {'trouser_id': trouser_id,
                            'size': size, 
                            'quantity': parseInt(quantity),
                };
                store.commit('increment', -parseInt(quantity));
                store.commit('changeTotalPrice', -parseInt(price));
                fetch("{% url 'cart:cart-remove' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'applications/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }, 
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then((response) => {
                    for(let i = 0; i < this.trousers.length; i++){
                        var trouser = this.trousers[i];
                        if (trouser.id === trouser_id && trouser.size === size){
                            key = trouser.key
                            this.trousers = this.trousers.filter(trouser => trouser.key !== key)
                        }
                    }
                })
                .catch(function (error){
                    console.log(error);
                })
            },
            incrementQuantity(trouser_id, size, quantity, price) {
                console.log(this.trousers)
                for(let i=0; i<this.trousers.length; i++){
                    let trouser = this.trousers[i]

                    if(trouser.id === trouser_id && trouser.size === size){
                        if (!(quantity >= trouser.stock)){
                            let data = {'trouser_id': trouser_id,
                            'size': size, 
                            'quantity': parseInt(quantity)+1,
                            'update': true,
                            };
                            store.commit('increment', 1);
                            store.commit('changeTotalPrice', parseFloat(price));
                            fetch("{% url 'cart:cart-add' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'applications/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }, 
                                credentials: 'same-origin',
                                body: JSON.stringify(data)
                            })
                            .then((response) => {
                                console.log(response)
                                for(let i = 0; i < this.trousers.length; i++){
                                    var trouser = this.trousers[i];

                                    if (trouser.id === trouser_id && trouser.size === size){
                                        this.trousers[i].quantity = parseInt(this.trousers[i].quantity) + 1;
                                        console.log("here")
                                        total_price = parseInt(this.trousers[i].quantity) * parseFloat(this.trousers[i].price)
                                        this.trousers[i].total_price = _.round(total_price, 2)
                                    }
                                }
                            })
                            .catch(function (error){
                                console.log(error);
                            })
                        } else{
                            this.toast = true
                            this.topT = Math.abs(this.$refs.bustop.getBoundingClientRect().top) + 350
                            setTimeout(function(){
                                this.toast = false
                            }.bind(this), 2000)
                        }
                    }

                }

            },
            decrementQuantity(trouser_id, size, quantity, price) {
                let data = {'trouser_id': trouser_id, 
                            'size': size, 
                            'quantity': parseInt(quantity)-1,
                            'update': true,
                        };
                
                store.commit('increment', -1);
                store.commit('changeTotalPrice', -parseFloat(price));

                if (parseInt(quantity)-1 === 0){
                    this.removeFromCart(trouser_id, size, quantity, price);
                } 
                else{
                    fetch("{% url 'cart:cart-add' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'applications/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }, 
                        credentials: 'same-origin',
                        body: JSON.stringify(data)
                    })
                    .then((response) => {
                        console.log(response)
                        for(let i = 0; i < this.trousers.length; i++){
                            var trouser = this.trousers[i];

                            if (trouser.id == trouser_id && trouser.size === size){
                                this.trousers[i].quantity = parseInt(this.trousers[i].quantity) - 1;
                                total_price = parseInt(this.trousers[i].quantity) * parseFloat(this.trousers[i].price)
                                this.trousers[i].total_price = _.round(total_price, 2)

                            }
                        }
                    })
                    .catch(function (error){
                        console.log(error);
                    })
                }

            },
        },
    });
</script>
{% endblock javascript %}